SET TIME ZONE 'Brazil/East';
WITH 
call_per_hour AS (SELECT 	DATE_TRUNC ('hour', created_at::timestamp AT TIME ZONE 'UTC')::TIME AS time,
COUNT(*) AS answered_calls, COUNT(DISTINCT agent_id) AS active_agents
FROM 	phone_call_records
WHERE 	inbound IS TRUE AND
DATE(created_at::timestamp AT TIME ZONE 'UTC') = '2018-12-04'
GROUP BY time), 

drop_per_hour AS (SELECT 	DATE_TRUNC ('hour', created_at::timestamp AT TIME ZONE 'UTC')::TIME AS time, 
COUNT(*) AS dropped_calls
FROM 	phone_call_drops
WHERE 	DATE(created_at::timestamp AT TIME ZONE 'UTC') = '2018-12-04'
GROUP BY time) 


SELECT call_per_hour.time, answered_calls::integer, dropped_calls::integer, (answered_calls + dropped_calls) ::integer AS total, active_agents :: integer 
FROM call_per_hour
JOIN drop_per_hour ON call_per_hour.time = drop_per_hour.time
